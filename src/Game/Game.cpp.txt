#include "Game.h"
#include <iostream>
#include <cstdlib>
#include <ctime>

Game::Game() : mode_(nullptr), turn_(1), gameOver_(false) {
    std::srand(time(nullptr));
}

Game::~Game() {
    if (mode_) delete mode_;
}

void Game::setup(const std::string& mode, const std::string& difficulty) {
    deck_.initialize();
  
    if (mode == "PvP") {
        mode_ = new PlayerVsPlayerMode();
    } else if (mode == "PvAI") {
        mode_ = new PlayerVsAIMode(difficulty);
    } else {
        mode_ = new PlayerVsPlayerMode(); 
    }
    
    mode_->initialize(deck_);
    
    std::cout << "Starting " << mode_->getModeName() << "\n";
}

void Game::start() {
    std::cout << "\n Farm game begins \n";
    
    while (!gameOver_) {
        std::cout << "\n Turn " << turn_ << " ---\n";
        
        Player* p1 = mode_->getPlayer1();
        Player* p2 = mode_->getPlayer2();
        
        if (p1) std::cout << p1->getName() << ": " << p1->getCoins() << " coins\n";
        if (p2) std::cout << p2->getName() << ": " << p2->getCoins() << " coins\n";
        
        if (mode_->hasWinner()) {
            Player* winner = mode_->getWinner();
            std::cout << "\nGAME OVER\n";
            std::cout << "Winner: " << winner->getName() << "!\n";
            std::cout << "Coins: " << winner->getCoins() << "\n";
            gameOver_ = true;
            break;
        }
        
        Player* player = mode_->getCurrentPlayer();
        
        std::cout << "\n" << player->getName() << "'s turn:\n";
 
        player->collectIncome();
        player->addCoins(1);
 
        if (player->hasWon()) {
            std::cout << player->getName() << " wins with " << player->getCoins() << " coins!\n";
            gameOver_ = true;
            break;
        }
        
        if (player->canTakeCard() && deck_.getCardCount() > 0) {
            Card* card = deck_.drawCard();
            player->addCardToHand(card);
            std::cout << "Draws: " << card->getName() << "\n";
        }
        
        int cardIndex = player->chooseCardToPlay();

        if (cardIndex >= 0) {
            player->playCard(cardIndex);
        }
        mode_->nextTurn();
        turn_++;
    }
}

bool Game::isOver() const {
    return gameOver_;
}